            const tc = parseInt(to.dataset.c);
            if (type === 'P' && ((color==='green'&&tr===3)||(color==='red'&&tr===10)||(color==='yellow'&&tc===10)||(color==='blue'&&tc===3))) type = 'Q';
            to.innerText = pieces[type]; to.dataset.type = type; to.dataset.color = color;
            to.classList.remove('red', 'green', 'blue', 'yellow'); to.classList.add(color);
            from.innerText = ''; delete from.dataset.type; delete from.dataset.color;
        }

        function canMove(from, to) {
            const fr = parseInt(from.dataset.r), fc = parseInt(from.dataset.c), tr = parseInt(to.dataset.r), tc = parseInt(to.dataset.c);
            const type = from.dataset.type, color = from.dataset.color, targetColor = to.dataset.color;
            if (targetColor === color) return false;
            const dr = Math.abs(tr - fr), dc = Math.abs(tc - fc);

            if (type === 'N') return (dr === 2 && dc === 1) || (dr === 1 && dc === 2);
            if (type === 'R') return (fr === tr || fc === tc) && isPathClear(fr, fc, tr, tc);
            if (type === 'B') return (dr === dc) && isPathClear(fr, fc, tr, tc);
            if (type === 'Q') return (fr === tr || fc === tc || dr === dc) && isPathClear(fr, fc, tr, tc);
            if (type === 'K') return dr <= 1 && dc <= 1;
            if (type === 'P') {
                if (targetColor) return dr === 1 && dc === 1 && ((color==='green'&&tr<fr)||(color==='red'&&tr>fr)||(color==='yellow'&&tc>fc)||(color==='blue'&&tc<fc));
                if (color==='green') return dc===0 && (fr===12 ? (fr-tr===1||fr-tr===2) : fr-tr===1) && tr<fr && isPathClear(fr,fc,tr,tc);
                if (color==='red') return dc===0 && (fr===1 ? (tr-fr===1||tr-fr===2) : tr-fr===1) && tr>fr && isPathClear(fr,fc,tr,tc);
                if (color==='yellow') return dr===0 && (fc===1 ? (tc-fc===1||tc-fc===2) : tc-fc===1) && tc>fc && isPathClear(fr,fc,tr,tc);
                if (color==='blue') return dr===0 && (fc===12 ? (fc-tc===1||fc-tc===2) : fc-tc===1) && tc<fc && isPathClear(fr,fc,tr,tc);
            }
            return false;
        }

        function isPathClear(fr, fc, tr, tc) {
            const dr = Math.sign(tr - fr), dc = Math.sign(tc - fc);
            let r = fr + dr, c = fc + dc;
            while (r !== tr || c !== tc) {
                if (document.querySelector(`.cell[data-r="${r}"][data-c="${c}"]`).dataset.type) return false;
                r += dr; c += dc;
            }
            return true;
        }
    </script>
</body>
</html>
